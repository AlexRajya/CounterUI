<!doctype html>
<title>counter</title>
<script src="https://unpkg.com/react@16/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/babel-standalone@6.15.0/babel.min.js"></script>

<main></main>

<script type="text/babel">
  function CounterApp() {
    const [items, setItems] = React.useState([]);
    const [text, setText] = React.useState('');

    function handleSubmit(e) {
      e.preventDefault();
      if (text.length === 0) {
        return;
      }
      const newItem = {
        text,
        id: Date.now(),
      };
      setItems(items.concat(newItem));
      setText('');
    }

    return (
      <div>
        <h3>Counters:</h3>
        <CounterList items={items} />
        <form onSubmit={handleSubmit}>
          <label htmlFor="new-count">
            New counter:
          </label>
          <input
            id="new-count"
            onChange={(e) => setText(e.target.value)}
            value={text}
          />
          <button>
            Add #{items.length + 1}
          </button>
        </form>
      </div>
    );
  }

  function CounterList(props) {
    return (
      <ol>
        {props.items.map(item => (
          <li key={item.id}>{item.text} <Counter item={item}/></li>
        ))}
      </ol>
    );
  }

  function Counter(props) {
    const [clicks, setClicks] = React.useState(0);

    React.useEffect(() => {
      //update once per second (Check timing)
      setInterval(get, 1000);

    }, [ /* no dependencies */ ]);

    function get(){
      let val = (get(props.item.text)).then(function(result) {
        setClicks(result);
      }, function(err) {
        console.log(err);
      });
    }

    function add(e){
      let ele = e.target.parentElement;
      let name = ele.id;
      let val = (post(name)).then(function(result) {
        setClicks(result);
      }, function(err) {
        console.log(err);
      });

    }
    return (
      <div id={props.item.text}>
        <p>Count: {clicks}</p>
        <button onClick={add}>+1</button>
        <button onClick={add}>Set</button>
        <button onClick={add}>Delete</button>
        <button onClick={get}>Refresh</button>
      </div>
    );
  }

  function url() {
    return window.location.href;
  }

  async function post(name){
    let newval = "1";
    try {
      const response = await fetch(url() + `/api/${encodeURIComponent(name)}`, { method: 'POST', body: newval });
      const text = response.text();
      return text;
    }catch(e){
      console.log(e);
      return 0;
    }
  }

  async function get(name){
    try {
      const response = await fetch(url() + `/api/${encodeURIComponent(name)}`, { method: 'GET' });
      const text = response.text();
      return text;
    }catch(e){
      console.log(e);
      return 0;
    }
  }

  ReactDOM.render(
    <CounterApp />,
    document.querySelector('main'),
  );
</script>
