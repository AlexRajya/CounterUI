<!doctype html>
<title>Counter API UI</title>
<script src="https://unpkg.com/react@16/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/babel-standalone@6.15.0/babel.min.js"></script>
<style>
  button {
    margin: 0px 5px;
  }
  li {
    margin: 10px;
  }
  h1 {
    margin: 0;
    padding: 10px;
    background-color: rgb(181, 181, 181);
  }
  h3 {
    margin: 0;
    padding: 20px;
  }
  label{
    margin: 10px;
    font-size: 120%;
  }
  form {
    background-color: rgb(206, 206, 206);
    padding: 10px;
  }
  body {
    margin: 0;
    background-color: rgb(216, 216, 216);
  }
</style>
<main></main>

<script type="text/babel">
  function CounterApp() {
    const [items, setItems] = React.useState([]);
    const [text, setText] = React.useState('');

    //Remove item from a list and delete register
    function handleRemove(name){
      let newList = items.filter((item) => item.text !== name);
      setItems(newList);//update list
      del(name);//delete datastore register
    }

    //Create a new item when form is submitted
    function handleSubmit(e) {
      e.preventDefault();
      //return if no name provided
      if (text.length === 0) {
        return;
      }
      const newItem = {
        text,
        id: Date.now(),
      };
      setItems(items.concat(newItem));
      //reset text to allow for new name to be entered
      setText('');
    }

    //For each item, assign a counter component and display in ordered list
    function CounterList(props) {
      return (
        <ol>
          {props.items.map(item => (
            <li key={item.id}>
            <b><u>{item.text}</u></b>
            <span>
              <button onClick={() => handleRemove(item.text)}>
                Remove
              </button>
            </span>
            <Counter item={item}/>
            </li>
          ))}
        </ol>
      );
    }

    //return CounterApp and it's components
    return (
      <div>
        <h1>Counter API User Interface:</h1>

        <form onSubmit={handleSubmit}>
          <label htmlFor="new-count">
            <b>New counter:</b>
          </label>
          <input
            id="new-count"
            onChange={(e) => setText(e.target.value)}
            value={text}
          />
          <button>
            Add #{items.length + 1}
          </button>
        </form>
        <h3> <b>Counters:</b> </h3>
        <CounterList items={items} />
      </div>
    );
  }

  //counter component
  function Counter(props) {
    const [clicks, setClicks] = React.useState(0);
    const [num, setNum] = React.useState(0);
    const name = props.item.text;

    React.useEffect(() => {
      //update once per second (1000ms = 1s)
      setInterval(getCount, 1000);
    }, [ /* no dependencies */ ]);

    function getCount(){
      get(name).then((result) => {
        setClicks(result);//update current count
      });
    }

    function addCount(e){
      post(name).then((result) => {
        setClicks(result);//update current count
      });
    }

    function deleteCount(e){
      del(name);
      setClicks(0);//update current count
    }

    function setCount(e){
      put(name, num).then((result) => {
        setClicks(result);//update current count
      });
    }

    return (
      <div id={name}>
        <p>Count: {clicks}</p>
        <input type="number"
          id="NumToSet"
          onChange={(e) => setNum(e.target.value)}
          value={num}
        />
        <button onClick={setCount}>Set</button>
        <button onClick={addCount}>+1</button>
        <button onClick={deleteCount}>Delete</button>
        <button onClick={getCount}>Refresh</button>
      </div>
    );
  }

  function url() {
    return window.location.href;//get current url
  }

  //use post to add num to the counter
  async function post(name){
    let addVal = "1";
    try {
      const response = await fetch(url() + `/api/${encodeURIComponent(name)}`, { method: 'POST', body: addVal });
      const text = response.text();
      return text;
    }catch(e){
      console.log(e);
      return 0;
    }
  }

  //use get to get val of named counter
  async function get(name){
    try {
      const response = await fetch(url() + `/api/${encodeURIComponent(name)}`, { method: 'GET' });
      const text = response.text();
      return text;
    }catch(e){
      console.log(e);
      return 0;
    }
  }

  //use put to set the val of a counter
  async function put(name, num){
    num = num.toString();
    try {
      const response = await fetch(url() + `/api/${encodeURIComponent(name)}`, { method: 'PUT', body: num });
      const text = response.text();
      return text;
    }catch(e){
      console.log(e);
      return 0;
    }
  }

  //use del to delete a counter from datastore
  async function del(name){
    try {
      const response = await fetch(url() + `/api/${encodeURIComponent(name)}`, { method: 'DELETE' });
    }catch(e){
      console.log(e);
    }
  }

  ReactDOM.render(
    <CounterApp />,
    document.querySelector('main'),
  );
</script>
