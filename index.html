<!doctype html>
<title>Counter API UI</title>
<script src="https://unpkg.com/react@16/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/babel-standalone@6.15.0/babel.min.js"></script>

<main></main>

<script type="text/babel">
  function CounterApp() {
    const [items, setItems] = React.useState([]);
    const [text, setText] = React.useState('');

    function handleSubmit(e) {
      e.preventDefault();
      if (text.length === 0) {
        return;
      }
      const newItem = {
        text,
        id: Date.now(),
      };
      setItems(items.concat(newItem));
      setText('');
    }

    return (
      <div>
        <h3>Counters:</h3>
        <CounterList items={items} />
        <form onSubmit={handleSubmit}>
          <label htmlFor="new-count">
            New counter:
          </label>
          <input
            id="new-count"
            onChange={(e) => setText(e.target.value)}
            value={text}
          />
          <button>
            Add #{items.length + 1}
          </button>
        </form>
      </div>
    );
  }

  function CounterList(props) {
    return (
      <ol>
        {props.items.map(item => (
          <li key={item.id}>{item.text} <Counter item={item}/></li>
        ))}
      </ol>
    );
  }

  function Counter(props) {
    const [clicks, setClicks] = React.useState(0);
    const [num, setNum] = React.useState(0);
    const name = props.item.text;

    React.useEffect(() => {
      //update once per second (1000ms = 1s)
      setInterval(getCount, 1000);
    }, [ /* no dependencies */ ]);

    function getCount(){
      get(name).then((result) => {
        setClicks(result);
      });
    }

    function addCount(e){
      post(name).then((result) => {
        setClicks(result);
      });
    }

    function deleteCount(e){
      del(name);
      setClicks(0);
    }

    function setCount(e){
      put(name, num).then((result) => {
        setClicks(result);
      });
    }

    return (
      <div id={name}>
        <p>Count: {clicks}</p>
        <input type="number"
          id="NumToSet"
          onChange={(e) => setNum(e.target.value)}
          value={num}
        />
        <button onClick={setCount}>Set</button>
        <button onClick={addCount}>+1</button>
        <button onClick={deleteCount}>Delete</button>
        <button onClick={getCount}>Refresh</button>
      </div>
    );
  }

  function url() {
    return window.location.href;
  }

  async function post(name){
    let addVal = "1";
    try {
      const response = await fetch(url() + `/api/${encodeURIComponent(name)}`, { method: 'POST', body: addVal });
      const text = response.text();
      return text;
    }catch(e){
      console.log(e);
      return 0;
    }
  }

  async function get(name){
    try {
      const response = await fetch(url() + `/api/${encodeURIComponent(name)}`, { method: 'GET' });
      const text = response.text();
      return text;
    }catch(e){
      console.log(e);
      return 0;
    }
  }

  async function put(name, num){
    num = num.toString();
    try {
      const response = await fetch(url() + `/api/${encodeURIComponent(name)}`, { method: 'PUT', body: num });
      const text = response.text();
      return text;
    }catch(e){
      console.log(e);
      return 0;
    }
  }

  async function del(name){
    try {
      const response = await fetch(url() + `/api/${encodeURIComponent(name)}`, { method: 'DELETE' });
    }catch(e){
      console.log(e);
    }
  }

  ReactDOM.render(
    <CounterApp />,
    document.querySelector('main'),
  );
</script>
